# Activity Log - 2026-01-17

### 01:45 - refactor: clone updates existing draft in place

- Clone button hidden for draft rows on list page and detail page
- Clone always available for active/archived rules
- Backend cloneAsDraft() updates existing draft in place instead of failing
- Draft row/ID preserved when cloning over existing draft

### 01:15 - fix: action label capitalization in pricing list

- Changed dropdown menu items to use `common:` namespace (Edit, Clone, Activate, Delete)
- Changed alert dialog titles and buttons to use `common:` namespace
- Ensures consistent capitalization across all action labels

### 01:00 - fix: clone button on pricing list page

- Changed from navigation (`/pricing/{id}/duplicate`) to `cloneMutation.mutate()`
- Shows error toast if draft already exists
- Added `draft_exists` translation: "A draft already exists. Delete the current draft before cloning."

### 00:50 - feat: add calculationMode UI to pricing forms

- Added Select component for calculation mode to create and edit pages
- Options: Discrete (default) or Cumulative
- Added help text explaining the difference between modes

### 00:35 - fix: rename duplicate to clone for pricing rules

- Fixed endpoint mismatch: admin called `/duplicate` but API uses `/clone`
- Removed `deactivate()` from pricingService (not part of immutable workflow)
- Renamed `useDuplicatePricingRule` hook to `useClonePricingRule`
- Updated pricing detail page to use `common:` namespace for action translations
- Added `calculationMode` field to create pricing rule form
- Added `clone`, `cloned`, `activate`, `activated` to common translations (en/es)
- Removed duplicate action translations from pricing namespace

### 23:30 - chore: sync types for pricing calculation_mode

- Synced types/generated.d.ts from API
- Regenerated runtime enums (added PricingCalculationMode)
- New enum supports cumulative vs discrete tier pricing

### 21:15 - refactor: remove "Set as Base" currency feature

- Removed "Set Base" button from Currency Settings UI
- Removed useSetBaseCurrency hook
- Removed setBase() from currencyService
- Base currency should be configured in seeder during initial deployment
- Changing base currency at runtime would break pricing rules, quotes, and orders

### 21:00 - fix: body wrapping bug in service layer

- Fixed `{ body: data }` â†’ `data` in 6 service files:
  - `driverService.ts` - update()
  - `userService.ts` - create(), update()
  - `quoteService.ts` - create(), update()
  - `exchangeRateService.ts` - sync()
  - `businessService.ts` - update()
- Previously fixed `currencyService.ts` - update()
- Bug caused API requests to send `{"body":{...}}` instead of actual data

### 20:30 - fix: currency update not persisting

- Fixed `currencyService.ts` sending `{ body: data }` instead of `data`
- Updates were showing "success" but API received wrong payload structure

### 20:15 - fix: 401 not logging out properly

- Added cookie clearing on 401 in API client
- Added hard redirect to `/login` after logout
- Store logout alone wasn't enough to clear session

### 20:00 - fix: CRC rounding increment

- Changed seeder from `rounding_increment: 5.00` to `rounding_increment: 1.00`

### 19:45 - feat: smart exchange rate sync

- Implemented per-currency skip logic - only fetches if today's rate is missing
- Changed `syncRates()` results to return 'synced', 'skipped', or 'failed' per currency
- Existing rates won't be overwritten during sync

### 19:30 - feat: seeder fetches live exchange rates

- Removed hardcoded rate values from CurrencySeeder
- Seeder now calls `ExchangeRateService.syncRates()` after creating currencies
- `storeRate()` now also updates cached rate on Currency model

### 19:15 - feat: add GoMeta exchange rate provider

- Created `GoMetaProvider.php` - free API, no registration required
- Uses BCCR sell rate (venta) for pricing conversions
- Set as default provider in config (fallback to BCCR)

### 19:00 - fix: USD showing "No rate" in currency settings

- Added fallback in CurrencyController to use cached rate on Currency model
- exchange_rates table lookup was failing, but cached fields existed

### 18:45 - refactor: login page to use React Query

- Created `useLoginMutation` hook in `hooks/auth/`
- Refactored login page to use mutation instead of direct service call

### 18:30 - chore: consolidate migrations for greenfield

- Merged exchange rate fields into `create_currencies_table` migration
- Merged `description`, `distance_km`, `estimated_minutes` into `create_orders_table` migration
- Refactored `create_pricing_tables` with `status` enum instead of `is_active` + `currency_code`
- Updated `create_quotes_table` with `pricing_rule_id`, removed `currency_code`
- Renamed pricing_tables migration (2025_10_27_193000) to run before quotes
- Deleted 5 obsolete incremental/refactoring migrations
- Verified with `migrate:fresh --seed` - all passes

### 17:00 - feat: implement Currency Settings UI (Phase 3 of exchange rate plan)

- Created currency hooks (useCurrencyList, useCurrencyMutations)
- Created exchange rate hooks (useExchangeRateList, useSyncExchangeRates)
- Created Currency Settings page at `/settings/currencies`
  - Lists all currencies with enable/disable toggles
  - Shows base currency with visual indicator
  - Displays current exchange rates and rate sources
  - "Sync Rates Now" button to trigger rate sync
  - Edit dialog for rounding mode and increment per currency
  - Set Base Currency confirmation dialog
- Updated Settings page with navigation to Currency Settings
- Updated pricing rules to use `status` enum (DRAFT, ACTIVE, ARCHIVED) instead of `isActive` boolean
- Removed `currencyCode` from pricing rules (all rules now in base currency)
- Updated quotes and CreateQuoteDialog to remove currency selection
- Added `types/generated.d.ts` and `coverage/**` to eslint ignores

### 15:30 - fix: pricing detail page badge alignment

- Moved Active/Inactive badge from title row to subtitle row
- Badge now displays inline with "CRC - v1" for cleaner layout
