# Activity Log - 2026-01-19

### 13:30 - feat: notification filters and search

API:

- Added text search across title, message, model_name (ILIKE)
- Added filters: model type, action, date range
- Fixed PostgreSQL JSON queries (cast text to jsonb)

Admin:

- Created notifications page with filters UI
- Text search input
- Type dropdown (Catalog, Catalog Element)
- Action dropdown (Created, Updated, Deleted, Restored)
- Date range inputs with validation (to >= from)
- Clear filters button

### 12:00 - fix: various notification improvements

- Bell dropdown shows only unread notifications
- Added refetching indicator to dropdown header
- Fixed catalog detail page elements loading state
- Catalog queries invalidate on broadcast (not just list)

### 11:45 - feat: add notifications page and toast close button

- Created `/notifications` page with full notification history
- Added pagination support to `useNotifications` hook
- Added "View all notifications" link to bell dropdown
- Added `closeButton` prop to Toaster for dismissible toasts

### 11:35 - feat: add notification navigation

API:

- Added `catalog_id` parameter to `CatalogUpdatedNotification`
- Updated `CatalogElementObserver` to pass `catalog_id` when notifying

Admin:

- Updated `NotificationItem` to navigate on click
- Catalogs navigate to `/catalogs/{id}`
- Catalog elements navigate to `/catalogs/{catalog_id}`
- Closes dropdown after navigation

### 11:25 - feat: implement notification system

API:

- Created `notifications` table (Laravel's built-in)
- Created `CatalogUpdatedNotification` with database + broadcast channels
- Created `NotificationController` with list, markAsRead, markAllAsRead, destroy
- Created `NotificationData` DTO
- Updated observers to notify admins on catalog changes
- Added `notifications` private channel authorization

Admin:

- Installed shadcn `popover` and `scroll-area` components
- Created `NotificationService` with API calls
- Created `useNotifications`, `useUnreadCount`, `useNotificationMutations` hooks
- Created `useNotificationBroadcast` for real-time toast + refresh
- Created `NotificationBell` with unread badge
- Created `NotificationDropdown` with scrollable list
- Created `NotificationItem` with read/unread styling
- Added `NotificationBell` to Header

### 10:35 - feat: implement real-time catalog broadcasts

- Implemented WebSocket broadcasting for catalog updates using Laravel Reverb
- Created `CatalogsUpdated` event with `ShouldBroadcast` interface
- Uses public `catalogs` channel (needed during registration, no auth required)
- Observers dispatch events on catalog/element create/update/delete
- Changed `QUEUE_CONNECTION=sync` in dev for immediate broadcasts without queue worker
- Production should use `database` or `redis` with queue workers

Admin changes:

- Created `lib/echo.ts` - Echo configuration with optional channel auth
- Created `providers/EchoProvider.tsx` - uses `useSyncExternalStore` to handle React Strict Mode
- Created `hooks/catalogs/useCatalogBroadcast.ts` - listens for catalog updates, resets store
- Created `stores/useCatalogStore.ts` - Zustand store with reactive hooks (`useCatalogElement`, `useCatalog`, `useCatalogByCode`)

Key fix: React Strict Mode double-invokes effects, which disconnected the Echo instance between invocations. Fixed by managing Echo outside React's render cycle with `useSyncExternalStore`.

Updated `docs/plans/catalog-broadcast.md` with final implementation details.
