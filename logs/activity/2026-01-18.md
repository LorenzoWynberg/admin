# Activity Log - 2026-01-18

### 22:55 - feat: add catalog store for reference data

- Created `stores/useCatalogStore.ts` - Zustand store with localStorage persistence
  - Stores catalogs and elements from API
  - Helper methods: getCatalogByCode, getElementById, getElementsByCatalogCode, etc.
- Created `hooks/catalogs/useCatalogStore.ts` - Hook to load catalogs into store
  - Fetches `/catalogs/all` when authenticated and store is empty
  - Uses React Query with 1-hour stale time
- Updated `AuthProvider` to call `useLoadCatalogs()` on app init
- Updated user detail page to get sex name from catalog store via `getElementById(user.sexId)`
- Simplified Account Type card in user detail - just icon and role name
- Added `CatalogService.all()` method for fetching all catalogs with elements

### 22:30 - feat: update admin to use publicId for routing and display

- Updated all services to use `string` IDs (publicId) instead of `number`: orderService, quoteService, userService, driverService, businessService
- Updated all hooks to accept `string` IDs: useOrder, useQuote, useUser, useDriver, useBusiness + all mutations
- Updated detail pages to use `params.id as string` instead of `Number(params.id)`
- Updated all list pages to navigate with `publicId` instead of `id`:
  - orders/page.tsx, quotes/page.tsx, users/page.tsx, drivers/page.tsx, businesses/page.tsx
- Updated ID display to show `publicId` (e.g., `ORD-A7X9K2B4N7T2`) instead of `#123`:
  - Order detail: header title
  - Quote detail: header title
  - User detail: subtitle
  - Driver detail: subtitle
  - Business detail: subtitle
- Updated cross-entity links to use `publicId`:
  - business -> user, driver -> user, user -> business
- Fixed `CreateQuoteDialog` to use `order.id` (numeric) for API calls, `quote.publicId` for mutations
- Synced types from API with `publicId` fields

### 20:45 - fix: i18n improvements across admin pages

- Fixed lowercase table headers with `capitalize()`:
  - orders/page.tsx: "cotización" → "Cotización" (Quote column)
  - quotes/page.tsx: "pedido" → "Pedido" (Order column)
  - users/page.tsx: "usuario" → "Usuario" (User column)
  - addresses/page.tsx: "dirección" → "Dirección" (Address column)
- Fixed `Attributes.serviceFee` showing raw key in pricing page:
  - Added `serviceFee` to validation attributes in all languages
- Added i18n translations for settings/currencies page:
  - Added 25+ currency-related keys to `common.php` (en/es/fr)
  - Keys: currency_settings, sync_rates, base_currency, currencies, rounding, etc.
- Fixed address type showing raw "saved" value:
  - Added `addresses:type.saved` and `addresses:type.snapshot` translations
  - Updated addresses page to use translated type
- Improved Account Type card in user detail:
  - Added CardDescription with `users:detail.account_type_description`

### 20:15 - feat: add i18n support to CreateQuoteDialog

- Replaced 31 hardcoded strings with `t()` calls
- Used `validationAttribute()` for field labels (distance, timeFee, surcharge, discount, etc.)
- Added defaultValue fallbacks for all translations
- Translation keys in `quotes:` namespace for dialog-specific strings
- Keys added: create.button, create.title, create.description, create.estimated_time, create.calculated_pricing, create.customer_will_see, create.no_pricing_rule, create.notes_placeholder, create.customer_requested_delivery, create.from_order_request, create.proposed_pickup, create.proposed_delivery, create.default_pickup_hint, create.default_delivery_hint, create.save_draft, create.create_send

### 19:35 - fix: i18n interpolation - lowercase model key and add capitalize formatter

- Fixed status badges showing raw template `{{model, capitalize}} Ready` instead of "Quote Ready"
- Changed `{ Model: ... }` to `{ model: ... }` in `utils/lang.ts` (admin)
- Added capitalize formatter to `config/i18next.ts` (front-end already had it)

### 19:25 - fix: dateTimeLocalToISO format for Laravel/Carbon compatibility

- Fixed quote creation failing with "Could not cast date" error
- Changed `date.toISOString()` to use format without milliseconds
- Format now: `2026-01-18T14:30:00+00:00` instead of `2026-01-18T14:30:00.000Z`
- Carbon requires `+00:00` timezone format, not `Z` suffix

### 19:20 - style: customer requested delivery full-width card

- Changed from inline with form grid to full-width card display
- Shows label with hint on left, formatted date on right
- Cleaner visual separation from quote form fields

### 19:10 - refactor: remove validUntil field from quote UI

- Removed validUntil input from CreateQuoteDialog
- Backend auto-sets `validUntil = pickupProposedFor` (quote valid until pickup time)
- Makes more sense: quote expires when proposed pickup would have happened

### 19:00 - feat: add currency conversion helper utilities

- Created `utils/currency.ts` with conversion helpers:
  - `getConversionRate()` - returns historical or live rate based on record status
  - `convertToCustomerCurrency()` - converts base amount to customer currency
  - `isRecordFinalized()` - checks if record is paid/accepted
  - `formatRateDisplay()` - formats rate as "1 USD = 490.28 CRC"
- Added 17 tests in `utils/__tests__/currency.test.ts`
- Backend already returns historical rates in `extra.rates` map keyed by date
- Logic: finalized (paid/accepted) records use historical rate, pending use live rate

### 18:55 - fix: correct currency conversion rate calculation

- Rate is stored as "target per 1 base" (e.g., 0.00204 USD per 1 CRC)
- Changed conversion from `amount / rate` to `amount * rate`
- Updated rate display to show inverse for clarity

### 18:50 - refactor: reorganize date/time fields in CreateQuoteDialog

- Moved Customer Requested Delivery next to Quote Valid Until (row 1)
- Moved Proposed Pickup and Proposed Delivery to row 2
- Customer Requested Delivery now uses datetime-local input (read-only)

### 18:40 - fix: make dialogs scrollable when content exceeds viewport

- Added `max-h-[calc(100vh-2rem)]` and `overflow-y-auto` to `DialogContent`
- Dialogs now scroll when content doesn't fit in viewport

### 18:20 - feat: add date/time fields to CreateQuoteDialog

- Added `customerDesiredDelivery` prop to show customer's requested delivery (read-only)
- Added date/time inputs for proposed pickup, delivery, and quote validity
- Added date formatting utilities to `utils/format.ts`:
  - `toDateTimeLocal(date)` - format Date for datetime-local input
  - `dateTimeLocalToISO(str)` - convert datetime-local to ISO string
  - `formatDateTime(iso, fallback)` - format ISO date for display
- Added tests for new date functions (96 total tests, 98.91% coverage)

### 11:45 - docs: add testing section and format helpers

- Added Testing section to CLAUDE.md with test commands
- Added Format Helpers section to docs/architecture.md

### 11:40 - test: achieve 100% coverage with new tests

- Extracted `formatCurrency` and `applyRounding` to `utils/format.ts`
- Updated `CreateQuoteDialog` to import from new utility file
- Added `utils/__tests__/format.test.ts` with 21 tests covering:
  - formatCurrency: symbol, precision, zero, negative, large, small amounts
  - applyRounding: up/down/nearest modes, edge cases (0, negative increment)
- Added `utils/__tests__/lang.test.ts` with 22 tests covering:
  - capitalize: basic, edge cases (empty, special chars)
  - validationAttribute, validationMessage, resourceMessage
  - crudSuccessMessage, crudErrorMessage
  - statusLabel, orderStatusLabel with i18next mocking
- Added 2 more tests to `utils/__tests__/form.test.ts`:
  - Single string error handling (not array)
  - Empty/falsy error values with default message
  - Default toast title when message is empty
  - Undefined status handling
- Total: 87 tests, 100% statement/branch/function/line coverage

### 11:05 - refactor: rename baseFare to serviceFee in admin pricing UI

- Updated all pricing pages to use `serviceFee` instead of `baseFare`:
  - `pricing/page.tsx` - table header and cell
  - `pricing/[id]/page.tsx` - detail view label
  - `pricing/create/page.tsx` - form schema, default values, submit data, form field
  - `pricing/[id]/edit/page.tsx` - form schema, default values, reset values, submit data, form field
- Updated `hooks/pricing/useCalculatePricing.ts` - interface uses `serviceFee`
- Updated `applyApiErrorsToForm` mapping from `base_fare` → `service_fee`
- Matches API rename from `base_fare` to `service_fee` column

### 10:50 - fix: pricing calculate API and read-only distance

- Fixed `pricingService.calculate()` - API returns data at root level, not wrapped in `item`
- Made distance field read-only when pre-filled from order (with muted background)

### 10:15 - feat: add live price calculation to CreateQuoteDialog

- Added `useCalculatePricing` hook in `hooks/pricing/useCalculatePricing.ts`
- Updated `CreateQuoteDialog` to show live price breakdown as user enters distance:
  - Base fare, distance fee, subtotal from active pricing rule
  - Adjustments section (time fee, surcharge, discount) shown when values entered
  - Tax and total calculation
  - Customer currency conversion preview (if customer has different preferred currency)
- Uses `useCurrencyList` to get base currency and customer currency rate info
- Completes quote creation feature from exchange rate system plan

### 09:56 - fix: increase table edge padding

- Changed `first:pl-4 last:pr-4` to `first:pl-6 last:pr-6` (16px → 24px)

### 09:54 - fix: add padding to table edges

- Added `first:pl-4 last:pr-4` to `TableHead` and `TableCell` components
- Adds horizontal padding on left/right edges of tables

### 09:44 - fix: update catalogs page to use elementsCount

- Changed `catalog.elements?.length` to `catalog.elementsCount ?? 0`
- Synced updated types from API with new `elementsCount` field

### 09:26 - docs: add strict-rules.md, jj-guide.md, and update CLAUDE.md

- Added `docs/strict-rules.md` - critical rules
- Added `docs/jj-guide.md` - jj version control reference
- Added `> IMPORTANT: Read docs/strict-rules.md first` at top of CLAUDE.md
- Updated all paths to reference local docs

### 09:18 - docs: update paths to shared docs in api/docs/

- Changed `../docs/strict-rules.md` to `../api/docs/strict-rules.md`
- Changed `../docs/jj-guide.md` to `../api/docs/jj-guide.md`
- Shared docs now live in API repo (root app/ is not a git repo)

### 09:15 - fix: correct api types path in CLAUDE.md

- Changed `cp ../api/types/generated.d.ts` to `cp ../api/resources/types/generated.d.ts`
- The generated types file is at `api/resources/types/generated.d.ts`, not `api/types/`

### 08:50 - refactor: extract status label helpers to lang.ts

- Added `statusLabel(status, modelKey?)` - base helper for any status with optional model interpolation
- Added `orderStatusLabel(status)` - convenience helper that auto-uses correct model key for estimated (quote) and assigned (driver)
- Simplified `OrderStatusBadge.tsx` to use `orderStatusLabel(status)` helper
- Removed inline translation logic from component

### 13:30 - refactor: centralize status translations to statuses namespace

- Created `statuses.php` in all languages (en/es/fr) with flat namespace structure
- Migrated status entries from orders.php, quotes.php, pricing.php
- Status keys: all, pending, estimated, approved, denied, canceled, assigned, picking_up, in_transit, completed, delivery_failed, unknown, draft, sent, accepted, rejected, expired, finalized, active, inactive, archived
- Used `:Model` interpolation for dynamic statuses (estimated → "Quote Ready", assigned → "Driver Assigned")
- Updated admin components:
  - `OrderStatusBadge.tsx` - uses `statuses:*` with Model interpolation
  - `QuoteStatusBadge.tsx` - uses `statuses:*` namespace
- Updated admin pages:
  - `orders/page.tsx` - statusOptions using statuses namespace
  - `quotes/page.tsx` - statusOptions using statuses namespace
  - `pricing/page.tsx` - filter and badges using statuses namespace
  - `pricing/[id]/page.tsx` - badges using statuses namespace
- Added `statuses` namespace to i18next config (admin and front-end)
- Regenerated i18n JSON files

### 11:45 - refactor: change validationAttribute default toUpper to true

- Changed default `toUpper` parameter from `false` to `true` in both admin and front-end
- Admin `utils/lang.ts`:
  - `validationAttribute(key, toUpper = true)` - default now capitalizes
  - Added explicit `false` in `validationMessage()` for mid-sentence usage
- Front-end `utils/lang.ts`:
  - `validationAttribute(key, toUpper = true)` - default now capitalizes
  - `validationAttributeWithPlurals(key, toUpper = true, count)` - default now capitalizes
  - Added explicit `false` in `validationMessage()` for mid-sentence usage
- Updated usages needing lowercase to pass explicit `false`:
  - `validation/auth/updatePasswordSchema.ts` - `other: validationAttribute('currentPassword', false)`
  - `screens/ChangePassword.tsx` - `resource: validationAttribute('password', false)`
- Pattern: Most usages are UI labels (capitalized), validation messages are mid-sentence (lowercase)

### 11:15 - fix: lowercase validation attributes and add toUpper param

- Fixed validation attributes in API lang files to be lowercase (singular form)
  - `api/lang/en/validation.php` - 50+ attributes changed from Title Case to lowercase
  - `api/lang/es/validation.php` - 50+ attributes changed to lowercase
- Updated all admin pages to use `toUpper` parameter when capitalization is needed
  - Table headers: `validationAttribute('name', true)`
  - Form labels: `validationAttribute('name', true)`
  - Card titles: `validationAttribute('name', true)`
  - Field labels in detail views: `validationAttribute('name', true)`
- Regenerated i18n JSON files from API
- Pattern: Use lowercase attributes with `toUpper=true` for UI labels

### 10:30 - refactor: update admin pages to use validationAttribute helper

- Updated all admin pages to use `validationAttribute()` and `resourceMessage()` helpers instead of namespace-specific translation keys
- Files updated:
  - `pricing/page.tsx` - table headers, error message
  - `pricing/[id]/page.tsx` - field labels, error message
  - `pricing/create/page.tsx` - form labels
  - `pricing/[id]/edit/page.tsx` - form labels, error message
  - `catalogs/page.tsx` - table headers, error message
  - `catalogs/[id]/page.tsx` - field labels, error message
  - `drivers/page.tsx` - table headers, error message
  - `drivers/[id]/page.tsx` - field labels, error message
  - `businesses/page.tsx` - table headers, error message
  - `businesses/[id]/page.tsx` - field labels, error message
  - `users/page.tsx` - error message
  - `users/[id]/page.tsx` - field labels, error message
  - `quotes/page.tsx` - error message
  - `quotes/[id]/page.tsx` - field labels, error message
  - `addresses/page.tsx` - table headers, error message
  - `orders/page.tsx` - error message
  - `orders/[id]/page.tsx` - field labels, error message
- Pattern: `t('namespace:field', { defaultValue })` → `validationAttribute('field')`
- Pattern: `t('namespace:failed_to_load', ...)` → `resourceMessage('failed_to_load', 'model_key', count)`
- All translations now consistently use validation.attributes namespace for field names
